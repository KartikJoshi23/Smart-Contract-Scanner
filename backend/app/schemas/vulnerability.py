from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime
from enum import Enum


class SeverityEnum(str, Enum):
    """How dangerous is the vulnerability."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class ConfidenceEnum(str, Enum):
    """How confident is the AI in this finding."""
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"


class VulnerabilityTypeEnum(str, Enum):
    """Types of vulnerabilities we detect."""
    REENTRANCY = "reentrancy"
    INTEGER_OVERFLOW = "integer_overflow"
    ACCESS_CONTROL = "access_control"
    UNCHECKED_CALL = "unchecked_call"
    FRONTRUNNING = "frontrunning"
    OTHER = "other"


# ============ RESPONSE SCHEMAS ============

class VulnerabilityBase(BaseModel):
    """Base vulnerability fields."""
    id: str
    type: VulnerabilityTypeEnum
    severity: SeverityEnum
    confidence: ConfidenceEnum
    verified: bool = False
    
    class Config:
        from_attributes = True


class VulnerabilitySummary(VulnerabilityBase):
    """
    Brief vulnerability info for list views.
    
    Used in analysis summaries.
    """
    line_start: Optional[int] = None
    function_name: Optional[str] = None
    description: str


class VulnerabilityDetail(VulnerabilityBase):
    """
    Full vulnerability info with all details.
    
    Used when viewing a single vulnerability or full report.
    """
    # Location
    line_start: Optional[int] = None
    line_end: Optional[int] = None
    function_name: Optional[str] = None
    code_snippet: Optional[str] = None
    
    # Explanation
    description: str
    impact: Optional[str] = None
    recommendation: Optional[str] = None
    fixed_code: Optional[str] = None
    
    # Extra info
    gas_estimate: Optional[str] = None
    references: Optional[List[dict]] = None
    
    # Foundry verification
    test_code: Optional[str] = None
    test_output: Optional[str] = None
    
    # Timestamp
    created_at: datetime


class VulnerabilityStats(BaseModel):
    """Statistics about vulnerabilities."""
    total: int
    by_severity: dict  # {"critical": 1, "high": 2, ...}
    by_type: dict      # {"reentrancy": 1, "access_control": 2, ...}
    verified_count: int


# ============ AI DETECTION SCHEMAS ============
# These are used internally when AI returns findings

class AIDetectedVulnerability(BaseModel):
    """
    Vulnerability as detected by AI (before verification).
    
    This is what we parse from the AI's JSON response.
    """
    type: VulnerabilityTypeEnum
    severity: SeverityEnum
    confidence: ConfidenceEnum = ConfidenceEnum.MEDIUM
    line_start: Optional[int] = None
    line_end: Optional[int] = None
    function_name: Optional[str] = None
    vulnerable_code: Optional[str] = None
    brief_reason: str


class AIExplanation(BaseModel):
    """
    Explanation generated by AI for a vulnerability.
    """
    description: str
    impact: str
    recommendation: str
    fixed_code: Optional[str] = None
    references: Optional[List[dict]] = None